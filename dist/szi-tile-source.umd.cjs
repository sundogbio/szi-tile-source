(function(f,l){typeof exports=="object"&&typeof module<"u"?l(exports):typeof define=="function"&&define.amd?define(["exports"],l):(f=typeof globalThis<"u"?globalThis:f||self,l(f.SziTileSource={}))})(this,function(f){"use strict";class l{static create=async(t,e)=>{const r=await this.fetchContentLength(t,e);return new l(t,r,e)};static fetchContentLength=async(t,e)=>{try{const r=await fetch(t,{method:"HEAD",headers:e.headers,mode:e.mode,credentials:e.credentials});if(!r.ok)throw new Error(`HTTP error! Status: ${r.status}`);const i=r.headers.get("content-length");if(!i)throw new Error("Couldn't get content length from headers");return parseInt(i,10)}catch(r){throw console.error("Error getting file size:",r),r}};constructor(t,e,r){this.url=t,this.size=e,this.fetchOptions=r}fetchRange=async(t,e,r)=>{if(t<0||t>this.size)throw new Error(`Start of fetch range (${t}) out of bounds (0 - ${this.size})!`);if(e<0||e>this.size)throw new Error(`Start of fetch range (${t}) out of bounds (0 - ${this.size})!`);if(t>e)throw new Error(`Start of fetch range (${t}) greater than end (${e})!`);const i=`bytes=${t}-${e-1}`,n=this.fetchOptions.headers?{...this.fetchOptions.headers,Range:i}:{Range:i},a=await fetch(this.url,{headers:n,signal:r,mode:this.fetchOptions.mode,credentials:this.fetchOptions.credentials});if(!a.ok)throw new Error(`Couldn't fetch range ${t}:${e} of ${url} of ${a.status}`);return await a.arrayBuffer()}}class h{constructor(t){this.buffer=t,this.view=new DataView(t),this.pos=0}checkBounds(t){if(t<0)throw new Error("Trying to move before start of buffer");if(t>this.buffer.byteLength)throw new Error("Trying to move after end of buffer")}readUint16(){const t=this.pos+2;this.checkBounds(t);const e=this.view.getUint16(this.pos,!0);return this.pos=t,e}readUint32(){const t=this.pos+4;this.checkBounds(t);const e=this.view.getUint32(this.pos,!0);return this.pos=t,e}readUint64(){const t=this.pos+8;this.checkBounds(t);const e=this.view.getBigUint64(this.pos,!0);if(this.pos=t,e>Number.MAX_SAFE_INTEGER)throw new Error("Only values upto 2^53 - 1 are supported!");return Number(e)}readUtf8String(t){const e=this.readUint8Array(t);return new TextDecoder().decode(e)}readUint8Array(t){const e=this.pos+t;this.checkBounds(e);const r=new Uint8Array(this.buffer,this.pos,t);return this.pos=e,r}skip(t){const e=this.pos+t;this.checkBounds(e),this.pos=e}}const m=4294967295,w=65535,S=w,U=22,z=20,O=1,b=101010256,D=117853008,L=101075792,R=33639248,A=67324752;function I(o,t,e){if(e.length>o.length)return-1;t=Math.min(t,o.length-e.length);for(let r=t;r>-1;r--){let i=!0;for(let n=0;n<e.length&&i;n++)o.at(r+n)!==e.at(n)&&(i=!1);if(i)return r}return-1}function v(o){const t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,b,!0),t}function $(o){const t=new Uint8Array(o),e=v();let r=o.byteLength-U;for(;r>=0;){const i=I(t,r,e);if(i===-1)throw new Error("Invalid SZI file, no valid End Of Central Directory Record found");const n=new h(o);if(n.skip(i),n.readUint32()!==b)throw new Error("Programming Error: End Of Central Directory Record has unexpected magic number");n.readUint16(),n.readUint16(),n.readUint16();const s=n.readUint16(),c=n.readUint32(),d=n.readUint32(),u=n.readUint16();if(n.pos+u===o.byteLength)return u>0&&n.readUtf8String(u),{totalEntries:s,centralDirectorySize:c,centralDirectoryOffset:d,startOfEocdInBuffer:i};r=i-1}if(r<0)throw new Error("Invalid SZI file, no End Of Central Directory Record found")}function k(o,t){const e=new h(o);if(e.skip(t),e.readUint32()!==D)throw new Error("Invalid SZI file: Zip64 End Of Central Directory Locator has unexpected magic number");e.readUint32();const i=e.readUint64();return e.readUint32(),{zip64EocdOffset:i}}function C(o,t){const e=new h(o);if(e.skip(t),e.readUint32()!==L)throw new Error("Invalid SZI file: Zip64 End Of Central Directory Record has unexpected magic number");const i=e.readUint64()+12;e.readUint16(),e.readUint16(),e.readUint32(),e.readUint32(),e.readUint64();const n=e.readUint64(),a=e.readUint64(),s=e.readUint64(),c=i-e.pos-t;return e.skip(c),{totalEntries:n,centralDirectorySize:a,centralDirectoryOffset:s}}function N(o,t,e){let{compressedSize:r,uncompressedSize:i,diskNumberStart:n,relativeOffsetOfLocalHeader:a}=e;const s=o.pos;for(;o.pos-s<t;){const c=o.readUint16(),d=o.readUint16();c===O?(i===m&&(i=o.readUint64()),r===m&&(r=o.readUint64()),a===m&&(a=o.readUint64()),n===w&&(n=o.readUint32())):o.skip(d)}return{compressedSize:r,uncompressedSize:i,diskNumberStart:n,relativeOffsetOfLocalHeader:a}}function x(o,t){const e=new h(o),r=[];for(let i=0;i<t;i++){if(e.readUint32()!==R)throw new Error(`Invalid SZI file: Central Directory Header ${i} has unexpected magic number`);e.readUint16(),e.readUint16(),e.readUint16(),e.readUint16(),e.readUint16(),e.readUint16(),e.readUint32();const a=e.readUint32(),s=e.readUint32(),c=e.readUint16(),d=e.readUint16(),u=e.readUint16(),T=e.readUint16();e.readUint16(),e.readUint32();const Z=e.readUint32(),E=e.readUtf8String(c);if(a!==s)throw new Error(`Invalid SZI file: compressedSize: ${a} and uncompressedSize: ${s} don't match for ${E}!`);const g=N(e,d,{compressedSize:a,uncompressedSize:s,diskNumberStart:T,relativeOffsetOfLocalHeader:Z});e.readUtf8String(u),r.push({compressedSize:g.compressedSize,uncompressedSize:g.uncompressedSize,relativeOffsetOfLocalHeader:g.relativeOffsetOfLocalHeader,filename:E})}return r}async function B(o){const t=Math.max(0,o.size-(z+U+S)),e=await o.fetchRange(t,o.size),{totalEntries:r,centralDirectoryOffset:i,centralDirectorySize:n,startOfEocdInBuffer:a}=$(e);if(r===w||i===m||n===m){const c=a-z,d=k(e,c),u=await o.fetchRange(d.zip64EocdOffset,t+c);return C(u,0)}else return{totalEntries:r,centralDirectoryOffset:i,centralDirectorySize:n}}function H(o,t){const e=new Map,r=o.toSorted((n,a)=>a.relativeOffsetOfLocalHeader-n.relativeOffsetOfLocalHeader);let i=t;for(const n of r){const a=n.relativeOffsetOfLocalHeader;e.set(n.filename,{start:a,maxEnd:i,bodyLength:n.uncompressedSize}),i=a}return e}async function F(o){const{totalEntries:t,centralDirectoryOffset:e,centralDirectorySize:r}=await B(o),i=await o.fetchRange(e,e+r),n=x(i,t);return H(n,e)}class p{static create=async t=>{const e=await F(t);return new p(t,e)};constructor(t,e){this.sziFile=t,this.contents=e}fetchFileBody=async(t,e)=>{const r=this.contents.get(t);if(!r)throw new Error(`${t} is not present inside this .szi file`);const i=await this.sziFile.fetchRange(r.start,r.maxEnd,e),n=new h(i,0);if(n.readUint32()!==A)throw new Error(`Invalid SZI file: Local Header for ${t} has unexpected magic number`);n.readUint16(),n.readUint16(),n.readUint16(),n.readUint16(),n.readUint16(),n.readUint32(),n.readUint32(),n.readUint32();const s=n.readUint16(),c=n.readUint16(),d=n.readUtf8String(s);if(d!==t)throw new Error(`Trying to read ${t} but actually got ${d}`);return n.skip(c),n.readUint8Array(r.bodyLength)};dziFilename=()=>{let t="";for(const e of this.contents.keys())if(e.match(/^([^\/]*)\/\1\.dzi$/)){if(t)throw new Error("Multiple .dzi files found in .szi!");t=e}if(!t)throw new Error("No dzi file found in .szi!");return t};tilesDirectory=()=>{const e=this.dziFilename().split("/")[0];return`${e}/${e}_files/`}}const y=o=>{class t extends o.DziTileSource{static createSziTileSource=async(r,i={})=>{if(i&&i.mode==="no-cors")throw new Error("'no-cors' mode is not supported, as Range headers don't work with it");const n=await l.create(r,i),a=await p.create(n),s=await this.readOptionsFromDziXml(a);return new t(a,s)};static async readOptionsFromDziXml(r){const i=r.dziFilename(),n=await r.fetchFileBody(i),a=new TextDecoder().decode(n),s=o.parseXml(a);return o.DziTileSource.prototype.configure(s,i,"")}constructor(r,i){super(i),this.remoteSziReader=r}downloadTileStart=r=>{const i=new Image;i.onload=function(){n(),r.finish(i,r.userData.request,null)},i.onabort=i.onerror=function(){n(),r.finish(null,r.userData.request,"Image load aborted.")};const n=()=>{i.onload=i.onerror=i.onabort=null};r.userData.image=i,r.userData.abortController=new AbortController,this.remoteSziReader.fetchFileBody(r.src,r.userData.abortController.signal).then(a=>{const s=new Blob([a]);s.size===0?(n(),r.finish(null,null,"Empty image!")):i.src=(window.URL||window.webkitURL).createObjectURL(s)},a=>{n(),r.finish(null,null,"Download failed: "+a.message)})};downloadTileAbort=r=>{const i=r.userData.abortController;i&&i.abort();const n=r.userData.image;n&&(n.onload=n.onerror=n.onabort=null)}}o.SziTileSource=t};(function(o,t){typeof f>"u"||typeof o.OpenSeadragon<"u"&&t(o.OpenSeadragon)})(typeof window<"u"?window:void 0,y),f.enableSziTileSource=y,Object.defineProperty(f,Symbol.toStringTag,{value:"Module"})});
